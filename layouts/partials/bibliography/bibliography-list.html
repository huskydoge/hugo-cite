{{/* -------------------- 1. BEGIN CITATION STYLE BLOCK -------------------- */}}
{{- $citationStyle := "apa" }}
{{- if site.Params.citationStyle }}
{{- $citationStyle = site.Params.citationStyle }}
{{- end }}

{{- if not (templates.Exists (printf "partials/bibliography/%s-style.html" $citationStyle)) }}
  {{- errorf "The provided citationStyle does not exist: `%s`. Please make sure that a file named `%s-style.html` file exists in your layouts/partials/bibliography directory." $citationStyle $citationStyle }}
{{- else }}
{{/* -------------------- END CITATION STYLE BLOCK -------------------- */}}

{{/* -------------------- 2. BEGIN REFERENCES BLOCK -------------------- */}}
{{- $references := .references }}

{{ if $references }}
<section class="hugo-cite-bibliography">
  <ul style="list-style-type: none; padding-left: 0; font-size: 0.9em;">
    {{/* -------------------- BEGIN RANGE BIBLIOGRAPHY -------------------- */}}
    {{- $partialPath := string (printf "bibliography/%s-style.html" $citationStyle) }}
    {{- if eq $citationStyle "ieee" -}}
      {{- $order := false -}}
      {{- $numMap := false -}}
      {{- with .Page }}
        {{- $order = .Scratch.Get "citedOrder" -}}
        {{- $numMap = .Scratch.Get "citedNum" -}}
      {{- end }}
      {{- if and $order (gt (len $order) 0) -}}
        {{- /* Build a map of id -> reference for quick lookup (handles slice or map) */ -}}
        {{- $refMap := dict -}}
        {{- range $k, $v := $references -}}
          {{- if (isset $v "id") -}}
            {{- $refMap = merge $refMap (dict $v.id $v) -}}
          {{- else -}}
            {{- /* If already map with key as id */ -}}
            {{- $refMap = merge $refMap (dict $k $v) -}}
          {{- end -}}
        {{- end -}}
        {{- range $i, $key := $order -}}
          {{- $currentRef := index $refMap $key -}}
          {{- if $currentRef -}}
          <li id="{{ $currentRef.id | urlize }}">
            <span>[{{ index $numMap $key }}] </span>
            {{- partial $partialPath $currentRef -}}
          </li>
          {{- end -}}
        {{- end -}}
      {{- else -}}
        {{- $counter := 0 -}}
        {{- range $refIndex, $currentRef := $references -}}
          {{- $counter = add $counter 1 -}}
          <li id="{{ $currentRef.id | urlize }}">
            <span>[{{ $counter }}] </span>
            {{- partial $partialPath $currentRef -}}
          </li>
        {{- end -}}
      {{- end -}}
    {{- else -}}
      {{- $counter := 0 -}}
      {{- range $refIndex, $currentRef := $references -}}
        {{- $counter = add $counter 1 -}}
        <li id="{{ $currentRef.id | urlize }}">
          <span>[{{ $counter }}] </span>
          {{- partial $partialPath $currentRef -}}
        </li>
      {{- end -}}
    {{- end -}}
    {{/* -------------------- END RANGE BIBLIOGRAPHY -------------------- */}}
  </ul>
</section>
{{- else }}
{{ printf "Bibliography called, but no references" }}
{{- end }}
{{- end }}
{{/* -------------------- END REFERENCES BLOCK -------------------- */}}